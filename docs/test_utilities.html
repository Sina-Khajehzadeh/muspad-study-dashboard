<!DOCTYPE html>
<html>
<head>
    <title>Test Chart Utilities</title>
</head>
<body>
    <h1>Testing Chart Utilities</h1>
    <div id="results"></div>
    
    <script>
        // Copy the utility functions from the main file
        function isNumericColumn(values) {
            if (!Array.isArray(values) || values.length === 0) return false;
            
            let numericCount = 0;
            let validCount = 0;
            
            for (const val of values) {
                if (val == null || val === '') continue;
                
                validCount++;
                
                if (typeof val === 'number' && !Number.isNaN(val)) {
                    numericCount++;
                    continue;
                }
                
                if (typeof val === 'string') {
                    const trimmed = val.trim();
                    
                    // If string contains non-numeric characters other than decimal point, minus, plus, e/E (scientific notation)
                    // then it's likely categorical even if it starts with numbers
                    const numericPattern = /^[+-]?(\d+\.?\d*|\.\d+)([eE][+-]?\d+)?$/;
                    
                    if (numericPattern.test(trimmed)) {
                        const num = parseFloat(trimmed);
                        if (!Number.isNaN(num) && Number.isFinite(num)) {
                            numericCount++;
                            continue;
                        }
                    }
                    
                    // Special case: if string starts with digits but contains letters or special chars
                    // (like "1000 bis unter 2000 Euro"), it's categorical
                    if (/^\d/.test(trimmed) && /[a-zA-Z]/.test(trimmed)) {
                        // This is likely a categorical value that starts with a number
                        continue; // Don't count as numeric
                    }
                }
            }
            
            return validCount > 0 && (numericCount / validCount) >= 0.7;
        }
        
        function coerceNumericArray(values) {
            const result = [];
            const errors = [];
            
            for (let i = 0; i < values.length; i++) {
                const val = values[i];
                
                if (val == null || val === '') {
                    continue;
                }
                
                if (typeof val === 'number' && !Number.isNaN(val) && Number.isFinite(val)) {
                    result.push(val);
                    continue;
                }
                
                if (typeof val === 'string') {
                    const num = parseFloat(val.trim());
                    if (!Number.isNaN(num) && Number.isFinite(num)) {
                        result.push(num);
                        continue;
                    }
                }
                
                errors.push({ index: i, value: val, type: typeof val });
            }
            
            return { values: result, errors };
        }
        
        // Test cases
        function runTests() {
            const results = document.getElementById('results');
            let html = '<h2>Test Results</h2>';
            
            // Test 1: Numeric column detection
            html += '<h3>Test 1: isNumericColumn</h3>';
            
            const numericTest1 = [1, 2, 3, 4, 5];
            const numericTest2 = ['1', '2', '3', '4', '5'];
            const numericTest3 = ['1000 bis unter 2000 Euro', '2000 bis unter 3000 Euro'];
            const categoricalTest = ['A', 'B', 'C', 'D'];
            const mixedTest = [1, '2', 3, 'invalid', 5];
            
            html += `<p>Pure numbers [1,2,3,4,5]: ${isNumericColumn(numericTest1)} (expected: true)</p>`;
            html += `<p>String numbers ['1','2','3','4','5']: ${isNumericColumn(numericTest2)} (expected: true)</p>`;
            html += `<p>Income strings: ${isNumericColumn(numericTest3)} (expected: false)</p>`;
            html += `<p>Categories ['A','B','C','D']: ${isNumericColumn(categoricalTest)} (expected: false)</p>`;
            html += `<p>Mixed [1,'2',3,'invalid',5]: ${isNumericColumn(mixedTest)} (expected: true - 80% numeric)</p>`;
            
            // Test 2: Numeric coercion
            html += '<h3>Test 2: coerceNumericArray</h3>';
            
            const coercionTest = [1, '2.5', null, 'invalid', '', 0, '100'];
            const result = coerceNumericArray(coercionTest);
            
            html += `<p>Input: [1, '2.5', null, 'invalid', '', 0, '100']</p>`;
            html += `<p>Valid numbers: [${result.values.join(', ')}] (expected: [1, 2.5, 0, 100])</p>`;
            html += `<p>Errors: ${result.errors.length} items (expected: 1 - 'invalid')</p>`;
            
            // Test 3: Simulate the age_group vs income issue
            html += '<h3>Test 3: Simulated age_group vs income aggregation</h3>';
            
            // Sample data like the dashboard would have
            const sampleData = [
                { age_group_22_1: '18-29', X20_21_langfragen_income: '1000 bis unter 2000 Euro' },
                { age_group_22_1: '18-29', X20_21_langfragen_income: '2000 bis unter 3000 Euro' },
                { age_group_22_1: '30-39', X20_21_langfragen_income: '3000 bis unter 4000 Euro' },
                { age_group_22_1: '30-39', X20_21_langfragen_income: '4000 bis unter 5000 Euro' },
            ];
            
            // Extract income values
            const incomeValues = sampleData.map(r => r.X20_21_langfragen_income);
            const isIncomeNumeric = isNumericColumn(incomeValues);
            
            html += `<p>Income column is numeric: ${isIncomeNumeric} (expected: false - these are categorical income ranges)</p>`;
            html += `<p>This explains the flat line issue - the income column contains text ranges, not numbers!</p>`;
            
            // Test with actual numeric income data
            const numericIncomeData = [
                { age_group_22_1: '18-29', income_numeric: 1500 },
                { age_group_22_1: '18-29', income_numeric: 2500 },
                { age_group_22_1: '30-39', income_numeric: 3500 },
                { age_group_22_1: '30-39', income_numeric: 4500 },
            ];
            
            // Group and aggregate properly
            const groups = new Map();
            numericIncomeData.forEach(row => {
                const group = row.age_group_22_1;
                if (!groups.has(group)) groups.set(group, []);
                groups.get(group).push(row.income_numeric);
            });
            
            html += '<p><strong>Correct aggregation with numeric income:</strong></p>';
            for (const [group, values] of groups) {
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                html += `<p>${group}: mean income = ${mean}</p>`;
            }
            
            results.innerHTML = html;
        }
        
        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>