<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Muspad Study</title>

<!-- ============ CDNs ============ -->
<!-- jQuery (needed by DataTables) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- PapaParse: CSV -> JS (runs in a Web Worker) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- DataTables + Scroller (virtual scrolling) -->
<link  href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" rel="stylesheet">
<link  href="https://cdn.datatables.net/scroller/2.4.1/css/scroller.dataTables.min.css" rel="stylesheet">
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/scroller/2.4.1/js/dataTables.scroller.min.js"></script>

<style>
  :root{
    --page-max: 1900px;
    --gap: 8px;
    --top-card-h: clamp(340px, 46vh, 640px);  /* unified height for the three top cards */
  }

  *{ box-sizing:border-box }
  body{ font-family:system-ui, Arial, sans-serif; background:#f6f7fb; margin:0 }
  h1{ text-align:center; padding:12px 4px; margin:0; font-weight:700 }

  /* 3-column grid (unchanged) */
  .grid{
    display:grid;
    grid-template-columns: 1.4fr 1.6fr 1.4fr;   /* left | middle | right */
    gap:var(--gap);
    max-width:var(--page-max);
    width:min(99vw, var(--page-max));
    margin:8px auto 18px;
    padding:0 6px;
    align-items:stretch;
  }
  @media (max-width:1200px){
    .grid{ grid-template-columns:1fr }
  }

  .card{
    background:#fff; border:1px solid #e6e9ef; border-radius:10px;
    box-shadow:0 1px 3px rgba(0,0,0,.04);
    padding:10px; display:flex; flex-direction:column; min-height:0;
  }
  .top-card{ height:var(--top-card-h); }

  /* Left card: table */
  .card h2{ font-size:16px; margin:0 0 8px 0; }
  .fill-scroll{ flex:1 1 auto; min-height:0; }

  /* DataTables tweaks */
  table.dataTable.compact thead th,
  table.dataTable.compact tbody td{
    padding: 6px 8px;            /* tighter */
    white-space: nowrap;         /* enable horizontal scroll for many columns */
    font-size: 12px;             /* small so the table stays neat */
  }
  div.dataTables_wrapper{
    width:100%;
  }

  /* Middle/Right charts via iframes (interactive Plotly HTMLs) */
  .chart-frame{
    width:100%;
    height:calc(var(--top-card-h) - 6px);
    border:none;
    border-radius:8px;
    background:#fff;
  }
</style>

<h1>Muspad Study â€” Descriptive Overview</h1>

<div class="grid">
  <!-- LEFT: Dataset (virtual scrolling table) -->
  <div class="card top-card">
    <h2>Muspad data set</h2>
    <div class="fill-scroll">
      <table id="dataset" class="display compact nowrap" style="width:100%">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- MIDDLE: Chart 1 (exported Plotly HTML) -->
  <div class="card top-card">
    <iframe class="chart-frame" src="plots/education.html" loading="lazy"></iframe>
  </div>

  <!-- RIGHT: Chart 2 (exported Plotly HTML) -->
  <div class="card top-card">
    <iframe class="chart-frame" src="plots/employment.html" loading="lazy"></iframe>
  </div>
</div>

<script>
  /* ========= Data loader (robust to comma/semicolon CSV) ========= */
  const CSV_PREVIEW = "data/df3_preview.csv"; // fast-loading preview slice
  // To switch to your full dataset later:
  // const CSV_PREVIEW = "data/df3_full_for_pivot.csv";

  function loadCSVAuto(url, done){
    const base = { download:true, header:true, skipEmptyLines:true, worker:true };
    Papa.parse(url, {
      ...base,
      complete: (res) => {
        if (res.data && res.data.length && Object.keys(res.data[0]||{}).length > 1) return done(null, res);
        Papa.parse(url, { ...base, delimiter:";", complete:(r2)=>done(null,r2), error:(e)=>done(e) });
      },
      error: (err) => done(err)
    });
  }

  function colsFromFields(fields){
    return fields.map(name => ({ title: name, data: name }));
  }

  function initDataTable(rows, fields){
    // If re-initialized, destroy previous instance
    if ($.fn.dataTable.isDataTable('#dataset')){
      $('#dataset').DataTable().clear().destroy();
      $('#dataset thead').empty();
    }

    // Build header
    const thead = document.querySelector('#dataset thead');
    const tr = document.createElement('tr');
    (fields || Object.keys(rows[0]||{})).forEach(col=>{
      const th = document.createElement('th');
      th.textContent = col;
      tr.appendChild(th);
    });
    thead.appendChild(tr);

    // Initialize DataTables with Scroller + horizontal scroll
    $('#dataset').DataTable({
      data: rows,
      columns: colsFromFields(fields),
      deferRender: true,                 // render only visible rows
      scroller: true,                    // virtual scrolling
      scrollY: 'calc(var(--top-card-h) - 70px)',  // stay inside card
      scrollX: true,                     // horizontal scroll for many columns
      scrollCollapse: true,
      paging: false,                     // continuous scroll (no pagination)
      searching: true,                   // user can search
      ordering: true,                    // column sorting
      info: false,
      autoWidth: false
    });
  }

  // Load CSV and build the table
  loadCSVAuto(CSV_PREVIEW, (err, res) => {
    if (err){
      console.error(err);
      document.querySelector('#dataset').outerHTML =
        '<div style="color:#b00; padding:8px;">Failed to load dataset.</div>';
      return;
    }
    const rows = (res.data || []).filter(r => Object.keys(r).length);
    const fields = res.meta?.fields || (rows[0] ? Object.keys(rows[0]) : []);
    initDataTable(rows, fields);
  });

  // Resize handler so the table keeps fitting the card height
  window.addEventListener('resize', () => {
    const dt = $('#dataset').DataTable();
    if (dt){
      dt.columns.adjust().draw(false);
    }
  });
</script>
