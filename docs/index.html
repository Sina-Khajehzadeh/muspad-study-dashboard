<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MUSPAD Study Dashboard</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.25.2.min.js"></script>
<style>
body { margin: 0; font-family: Arial, sans-serif; }
#sidebar { width: 60px; background-color: #f8f9fa; border-right: 1px solid #ddd; position: fixed; top: 0; bottom: 0; left: 0; padding-top: 10px; }
#sidebar button { width: 100%; margin-bottom: 15px; border: none; background: none; font-size: 1.5rem; }
#main { margin-left: 60px; padding: 10px; }
.panel { display: none; background-color: #f8f9fa; border-bottom: 1px solid #ddd; padding: 15px; }
.card { margin-bottom: 20px; }
</style>
</head>
<body>
<div id="sidebar">
<button id="filterToggle"><i class="bi bi-funnel-fill" title="Filters"></i></button>
<button id="dataToggle"><i class="bi bi-table" title="Data"></i></button>
<button id="settingsToggle"><i class="bi bi-gear-fill" title="Settings"></i></button>
</div>
<div id="main">
<header class="d-flex justify-content-between align-items-center mb-3">
<h2 id="title">MUSPAD Study Dashboard</h2>
<div>
<input type="date" id="startDate"> to <input type="date" id="endDate">
</div>
</header>
<div id="filterPanel" class="panel">
<h5>Filters</h5>
<div class="mb-2">
<label>Age Groups</label>
<select id="ageFilter" multiple class="form-select"></select>
</div>
<div>
<label>Employment Types</label>
<select id="employmentFilter" multiple class="form-select"></select>
</div>
</div>
<div id="dataPanel" class="panel">
<h5>Data Table</h5>
<div id="dataTable"></div>
</div>
<div id="settingsPanel" class="panel">
<h5>Settings</h5>
<p>Placeholder for future customization settings.</p>
</div>
<div class="row" id="chartsContainer">
<div class="col-md-6">
<div class="card">
<div class="card-body">
<h5 class="card-title">Time Series</h5>
<div id="timeSeriesChart"></div>
</div>
</div>
<div class="card">
<div class="card-body">
<h5 class="card-title">Serostatus Distribution</h5>
<div id="pieChart"></div>
</div>
</div>
</div>
<div class="col-md-6">
<div class="card">
<div class="card-body">
<h5 class="card-title">Employment Type Counts</h5>
<div id="barChartEmp"></div>
</div>
</div>
<div class="card">
<div class="card-body">
<h5 class="card-title">Average Income by Education</h5>
<div id="barChartIncome"></div>
</div>
</div>
</div>
<div class="col-md-12">
<div class="card">
<div class="card-body">
<h5 class="card-title">Mask Usage vs Income</h5>
<div id="scatterChart"></div>
</div>
</div>
</div>
<div class="col-md-12">
<div class="card">
<div class="card-body">
<h5 class="card-title">Summary Statistics</h5>
<div id="summaryTable"></div>
</div>
</div>
</div>
</div>
</div>
<script>
const DATA_URL = "https://raw.githubusercontent.com/Sina-Khajehzadeh/muspad-study-dashboard/main/docs/data/df3_full_for_pivot.csv";
let dataset = [];
document.addEventListener('DOMContentLoaded', init);
function init() {
  Papa.parse(DATA_URL, {
    download: true,
    header: true,
    dynamicTyping: true,
    complete: function(results) {
      dataset = results.data.filter(row => row.date);
      initFilters();
      updateCharts();
    }
  });
  document.getElementById('filterToggle').addEventListener('click', () => togglePanel('filterPanel'));
  document.getElementById('dataToggle').addEventListener('click', () => togglePanel('dataPanel'));
  document.getElementById('settingsToggle').addEventListener('click', () => togglePanel('settingsPanel'));
  document.getElementById('startDate').addEventListener('change', updateCharts);
  document.getElementById('endDate').addEventListener('change', updateCharts);
  document.getElementById('ageFilter').addEventListener('change', updateCharts);
  document.getElementById('employmentFilter').addEventListener('change', updateCharts);
}
function initFilters() {
  dataset.forEach(row => row.date = new Date(row.date));
  const ages = [...new Set(dataset.map(row => row.age_group).filter(v => v))];
  const emps = [...new Set(dataset.map(row => row.employment_type).filter(v => v))];
  const ageSelect = document.getElementById('ageFilter');
  ages.forEach(val => {
    const opt = document.createElement('option');
    opt.value = val;
    opt.textContent = val;
    opt.selected = true;
    ageSelect.appendChild(opt);
  });
  const empSelect = document.getElementById('employmentFilter');
  emps.forEach(val => {
    const opt = document.createElement('option');
    opt.value = val;
    opt.textContent = val;
    opt.selected = true;
    empSelect.appendChild(opt);
  });
  const dates = dataset.map(row => row.date);
  const minDate = new Date(Math.min(...dates));
  const maxDate = new Date(Math.max(...dates));
  document.getElementById('startDate').value = minDate.toISOString().split('T')[0];
  document.getElementById('endDate').value = maxDate.toISOString().split('T')[0];
}
function togglePanel(panelId) {
  const panel = document.getElementById(panelId);
  panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
}
function getFilteredData() {
  const start = new Date(document.getElementById('startDate').value);
  const end = new Date(document.getElementById('endDate').value);
  const selectedAges = Array.from(document.getElementById('ageFilter').selectedOptions).map(o => o.value);
  const selectedEmps = Array.from(document.getElementById('employmentFilter').selectedOptions).map(o => o.value);
  return dataset.filter(row =>
    row.date >= start && row.date <= end &&
    selectedAges.includes(row.age_group) &&
    selectedEmps.includes(row.employment_type)
  );
}
function updateCharts() {
  const data = getFilteredData();
  if (!data.length) return;
  const weekCounts = {};
  data.forEach(row => {
    const weekStart = new Date(row.date);
    weekStart.setUTCHours(0,0,0,0);
    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
    const key = weekStart.toISOString().split('T')[0];
    weekCounts[key] = (weekCounts[key] || 0) + 1;
  });
  const tsX = Object.keys(weekCounts).sort();
  const tsY = tsX.map(k => weekCounts[k]);
  Plotly.newPlot('timeSeriesChart', [{
    x: tsX,
    y: tsY,
    mode: 'lines+markers',
    line: { shape: 'linear' }
  }], {title: 'Weekly Record Count', xaxis: {title: 'Week'}, yaxis: {title: 'Count'}, margin: {t: 30}});
  // serostatus distribution
  const seroCounts = {};
  data.forEach(row => {
    seroCounts[row.serostatus] = (seroCounts[row.serostatus] || 0) + 1;
  });
  Plotly.newPlot('pieChart', [{
    labels: Object.keys(seroCounts),
    values: Object.values(seroCounts),
    type: 'pie',
    hole: 0.4
  }], { title: 'Serostatus Distribution', margin: {t: 30} });
  // employment counts
  const empCounts = {};
  data.forEach(row => {
    empCounts[row.employment_type] = (empCounts[row.employment_type] || 0) + 1;
  });
  Plotly.newPlot('barChartEmp', [{
    x: Object.keys(empCounts),
    y: Object.values(empCounts),
    type: 'bar'
  }], { title: 'Employment Type Counts', xaxis: {title: 'Employment Type'}, yaxis: {title: 'Count'}, margin: {t: 30} });
  // average income by education
  const eduIncome = {};
  data.forEach(row => {
    const key = row.education_level;
    if (!eduIncome[key]) eduIncome[key] = [];
    if (row.income !== undefined && row.income !== null) eduIncome[key].push(row.income);
  });
  const eduX = Object.keys(eduIncome);
  const eduY = eduX.map(k => mean(eduIncome[k]));
  Plotly.newPlot('barChartIncome', [{
    x: eduX,
    y: eduY,
    type: 'bar'
  }], { title: 'Average Income by Education', xaxis: {title: 'Education Level'}, yaxis: {title: 'Average Income'}, margin: {t: 30} });
  // scatter chart
  const scatterTrace = {
    x: data.map(row => row.income),
    y: data.map(row => row.mask_usage),
    mode: 'markers',
    type: 'scatter',
    text: data.map(row => row.age_group),
    marker: { color: data.map(row => row.serostatus) }
  };
  Plotly.newPlot('scatterChart', [scatterTrace], { title: 'Mask Usage vs Income', xaxis: {title: 'Income'}, yaxis: {title: 'Mask Usage'}, margin: {t: 30} });
  // summary table
  const incomeArr = data.map(row => row.income).filter(val => val != null && val !== '');
  const maskArr = data.map(row => row.mask_usage).filter(val => val != null && val !== '');
  const summary = [
    ['Metric', 'Income', 'Mask Usage'],
    ['Mean', mean(incomeArr).toFixed(2), mean(maskArr).toFixed(2)],
    ['Median', median(incomeArr).toFixed(2), median(maskArr).toFixed(2)],
    ['Min', Math.min(...incomeArr).toFixed(2), Math.min(...maskArr).toFixed(2)],
    ['Max', Math.max(...incomeArr).toFixed(2), Math.max(...maskArr).toFixed(2)],
  ];
  let htmlTable = '<table class="table table-sm"><thead><tr>';
  summary[0].forEach(h => htmlTable += '<th>' + h + '</th>');
  htmlTable += '</tr></thead><tbody>';
  for (let i=1; i<summary.length; i++) {
    htmlTable += '<tr>';
    summary[i].forEach(cell => htmlTable += '<td>' + cell + '</td>');
    htmlTable += '</tr>';
  }
  htmlTable += '</tbody></table>';
  document.getElementById('summaryTable').innerHTML = htmlTable;
  // data table preview
  const dataHTML = [];
  dataHTML.push('<table class="table table-striped table-sm"><thead><tr>');
  const cols = Object.keys(data[0]);
  cols.forEach(col => dataHTML.push('<th>' + col + '</th>'));
  dataHTML.push('</tr></thead><tbody>');
  const previewRows = data.slice(0, 200);
  previewRows.forEach(row => {
    dataHTML.push('<tr>');
    cols.forEach(col => dataHTML.push('<td>' + (row[col] ?? '') + '</td>'));
    dataHTML.push('</tr>');
  });
  dataHTML.push('</tbody></table>');
  document.getElementById('dataTable').innerHTML = dataHTML.join('');
}
function mean(arr) {
  return arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
}
function median(arr) {
  if (!arr.length) return 0;
  const sorted = arr.slice().sort((a, b) => a - b);
  const mid = Math.floor(sorted.length / 2);
  return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
}
</script>
</body>
</html>
