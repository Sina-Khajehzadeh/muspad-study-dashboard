<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Muspad Study</title>

<!-- ============ CDNs ============ -->
<!-- jQuery (needed by DataTables) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- PapaParse: CSV -> JS (runs in a Web Worker) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- DataTables + Scroller (virtual scrolling) -->
<link  href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" rel="stylesheet">
<link  href="https://cdn.datatables.net/scroller/2.4.1/css/scroller.dataTables.min.css" rel="stylesheet">
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/scroller/2.4.1/js/dataTables.scroller.min.js"></script>

<style>
  :root{
    --page-max: 1900px;
    --gap: 8px;

    /* keep your top card heights aligned */
    --top-card-h: clamp(340px, 46vh, 640px);

    /* initial preview size for the table (around 12 rows x 10 cols) */
    --preview-rows: 12;
    --preview-row-h: 26px;
    --preview-header-h: 30px;

    /* bottom area (optional if you add anything later) */
    --bottom-h: 58vh;
  }

  *{ box-sizing:border-box }
  body{ font-family:system-ui, Arial, sans-serif; background:#f6f7fb; margin:0 }
  h1{ text-align:center; padding:12px 4px; margin:0; font-weight:700 }

  /* 3-column grid kept exactly as requested */
  .grid{
    display:grid;
    grid-template-columns: 1.4fr 1.6fr 1.4fr;
    gap:var(--gap);
    max-width:var(--page-max);
    width:min(99vw, var(--page-max));
    margin:8px auto 18px;
    padding:0 6px;
    align-items:stretch;
  }
  @media (max-width:1200px){ .grid{ grid-template-columns:1fr } .span-all{ grid-column:1 / -1 } }

  .card{
    background:#fff; border:1px solid #e6e9ef; border-radius:10px;
    box-shadow:0 1px 3px rgba(0,0,0,.04);
    padding:10px; display:flex; flex-direction:column; min-height:0;
  }

  .top-card{ height:var(--top-card-h); }

  /* ===== Left: dataset card ===== */
  .card h2{ font-size:16px; margin:0 0 8px 0; }

  /* Preview box: fixed height, both scrollbars */
  #preview-box{
    border:1px solid #eef2f9; border-radius:8px; padding:6px;
    max-height: calc(var(--preview-header-h) + var(--preview-rows) * var(--preview-row-h));
    overflow:auto;
    font-size:12px;
  }
  #preview-box table{ width:100%; border-collapse:collapse; white-space:nowrap }
  #preview-box th, #preview-box td{
    border:1px solid #e5e8ef; padding:4px 6px; text-align:left;
    height:var(--preview-row-h);
    line-height:calc(var(--preview-row-h) - 6px);
  }
  #preview-box th{
    position:sticky; top:0; background:#f2f5fb; height:var(--preview-header-h);
    line-height:calc(var(--preview-header-h) - 6px);
  }

  .row-actions{ margin-top:8px; display:flex; gap:8px; align-items:center }
  .btn{
    display:inline-block; padding:6px 10px; border-radius:8px; border:1px solid #d6ddea;
    background:#f7f9ff; cursor:pointer; font-size:12px;
  }
  .btn:hover{ background:#eef2ff }

  /* Full table wrapper replaces the preview area after click */
  #table-wrap{ display:none; min-height:0; flex:1 1 auto; }
  #bigTable{ width:100%; font-size:12px; }

  /* enable horizontal scroll for many columns */
  div.dataTables_wrapper {
    width: 100%;
  }

  /* ===== Middle / Right: charts via iframes ===== */
  .chart-frame{
    width:100%; height: calc(var(--top-card-h) - 10px);
    border: none; border-radius:8px; background:#fff;
  }

  /* ===== Optional bottom section (if you add more later) ===== */
  .span-all{ grid-column:1 / -1; }
  .bottom{ height:var(--bottom-h); }
</style>

<h1>Muspad Study — Descriptive Overview</h1>

<div class="grid">

  <!-- LEFT: Dataset -->
  <div class="card top-card">
    <h2>Muspad data set</h2>

    <!-- Small preview first (fast) -->
    <div id="preview-box"></div>

    <div class="row-actions">
      <button class="btn" id="load-full">Load full data (virtual scroll)</button>
      <span id="load-note" style="color:#667;font-size:12px"></span>
    </div>

    <!-- Full DataTables grid (appears after button click) -->
    <div id="table-wrap">
      <table id="bigTable" class="display nowrap"></table>
    </div>
  </div>

  <!-- MIDDLE: Chart 1 -->
  <div class="card top-card">
    <!-- point src to your exported Plotly HTML -->
    <iframe class="chart-frame" src="plots/education.html" loading="lazy"></iframe>
  </div>

  <!-- RIGHT: Chart 2 -->
  <div class="card top-card">
    <iframe class="chart-frame" src="plots/employment.html" loading="lazy"></iframe>
  </div>

  <!-- (Optional) bottom area for anything else later -->
  <!-- <div class="card span-all bottom"></div> -->
</div>

<script>
  /* ---------- CONFIG ---------- */
  const CSV_URL = "data/df3_full.csv";           // your big dataset
  const PREVIEW_ROWS = 12;                        // ~12 rows
  const PREVIEW_COLS = 10;                        // ~10 columns visible in preview

  /* ---------- Build preview (cheap & instant) ---------- */
  function renderPreview(rows, cols){
    const el = document.getElementById("preview-box");
    const subsetCols = cols.slice(0, PREVIEW_COLS);
    const subsetRows = rows.slice(0, PREVIEW_ROWS);

    const esc = s => String(s==null? "":s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

    let html = "<table><thead><tr>";
    for (const c of subsetCols) html += `<th>${esc(c)}</th>`;
    html += "</tr></thead><tbody>";

    for (const r of subsetRows){
      html += "<tr>";
      for (const c of subsetCols) html += `<td>${esc(r[c])}</td>`;
      html += "</tr>";
    }
    html += "</tbody></table>";
    el.innerHTML = html;
  }

  /* ---------- Load CSV (Papa) then init preview ---------- */
  let cachedRows = null, cachedCols = null;

  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    worker: true,
    skipEmptyLines: true,
    complete: (res) => {
      const rows = res.data.filter(r => Object.keys(r).length);
      const cols = res.meta.fields || (rows[0] ? Object.keys(rows[0]) : []);
      cachedRows = rows; cachedCols = cols;
      renderPreview(rows, cols);
      document.getElementById("load-note").textContent = `(${rows.length.toLocaleString()} rows, ${cols.length} columns)`;
    },
    error: (err) => {
      document.getElementById("preview-box").textContent = "Failed to load CSV.";
      console.error(err);
    }
  });

  /* ---------- Button: swap preview → full DataTables (virtual scroll) ---------- */
  document.getElementById("load-full").addEventListener("click", () => {
    if (!cachedRows || !cachedCols) return;

    // Hide preview, show full table wrapper
    document.getElementById("preview-box").style.display = "none";
    document.getElementById("table-wrap").style.display = "block";

    // Map columns for DataTables (object data source)
    const dtCols = cachedCols.map(c => ({ title: c, data: c }));

    // Init DataTable with Scroller + horizontal/vertical scroll
    $('#bigTable').DataTable({
      data: cachedRows,
      columns: dtCols,

      deferRender: true,          // build rows only as needed
      scrollY:  (window.innerHeight * 0.40) + "px", // ~40% viewport height
      scrollX:  true,
      scroller: true,             // virtual scrolling
      scrollCollapse: true,
      paging: false,              // no pagination, continuous scroll
      searching: true,            // built-in clientside search (optional)
      ordering: true,             // sort columns (optional)
      info: true,                 // "Showing x of y" (optional)
      stateSave: false,           // set true if you want to persist table state
      autoWidth: false
    });
  });
</script>
