<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Muspad Study</title>

<!-- ======== CDNs (order matters) ======== -->
<!-- jQuery (DataTables + PivotTable.js depend on this) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- jQuery UI (for PivotTable drag/drop) -->
<link rel="stylesheet" href="https://unpkg.com/jquery-ui-dist@1.13.2/jquery-ui.min.css">
<script src="https://unpkg.com/jquery-ui-dist@1.13.2/jquery-ui.min.js"></script>

<!-- PapaParse: CSV -> JS (we'll use worker:false for GH Pages) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- DataTables + Scroller (virtual scrolling) -->
<link  href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" rel="stylesheet">
<link  href="https://cdn.datatables.net/scroller/2.4.1/css/scroller.dataTables.min.css" rel="stylesheet">
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/scroller/2.4.1/js/dataTables.scroller.min.js"></script>

<!-- PivotTable.js (with optional Plotly renderers) -->
<link  rel="stylesheet" href="https://unpkg.com/pivottable@2.23.0/dist/pivot.css">
<script src="https://unpkg.com/pivottable@2.23.0/dist/pivot.min.js"></script>
<script src="https://unpkg.com/pivottable@2.23.0/dist/plotly_renderers.min.js"></script>

<!-- Plotly (for PivotTable Plotly renderers; your iframes load their own) -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style>
  :root{
    --page-max: 1900px;
    --gap: 8px;
    --top-card-h: clamp(340px, 46vh, 640px); /* unified height for top row */
  }

  *{ box-sizing:border-box }
  body{ font-family:system-ui, Arial, sans-serif; background:#f6f7fb; margin:0 }
  h1{ text-align:center; padding:12px 4px; margin:0; font-weight:700 }

  /* 3-column grid (unchanged) */
  .grid{
    display:grid;
    grid-template-columns: 1.4fr 1.6fr 1.4fr;   /* left | middle | right */
    gap:var(--gap);
    max-width:var(--page-max);
    width:min(99vw, var(--page-max));
    margin:8px auto 18px;
    padding:0 6px;
    align-items:stretch;
  }
  @media (max-width:1200px){
    .grid{ grid-template-columns:1fr }
  }

  .card{
    background:#fff; border:1px solid #e6e9ef; border-radius:10px;
    box-shadow:0 1px 3px rgba(0,0,0,.04);
    padding:10px; display:flex; flex-direction:column; min-height:0;
  }
  .top-card{ height:var(--top-card-h); }

  /* Left card: dataset table */
  .card h2{ font-size:16px; margin:0 0 6px 0; }
  .fill-scroll{ flex:1 1 auto; min-height:0; }

  /* DataTables compact look */
  table.dataTable.compact thead th,
  table.dataTable.compact tbody td{
    padding: 6px 8px;
    white-space: nowrap;  /* horizontal scroll if many columns */
    font-size: 12px;
  }
  div.dataTables_wrapper{ width:100%; }

  /* Plotly iframes (charts) */
  .chart-frame{
    width:100%;
    height:calc(var(--top-card-h) - 6px);
    border:none;
    border-radius:8px;
    background:#fff;
  }
</style>

<h1>Muspad Study — Descriptive Overview</h1>

<!-- ======= TOP ROW ======= -->
<div class="grid">
  <!-- LEFT: Dataset (virtual scrolling table) -->
  <div class="card top-card">
    <h2>Muspad data set</h2>
    <div id="table-status" style="font-size:12px;color:#667;margin:4px 0 6px;">Loading…</div>
    <div class="fill-scroll">
      <table id="dataset" class="display compact nowrap" style="width:100%">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- MIDDLE: Chart 1 (exported Plotly HTML) -->
  <div class="card top-card">
    <iframe class="chart-frame" src="plots/education.html" loading="lazy"></iframe>
  </div>

  <!-- RIGHT: Chart 2 (exported Plotly HTML) -->
  <div class="card top-card">
    <iframe class="chart-frame" src="plots/employment.html" loading="lazy"></iframe>
  </div>
</div>

<!-- ======= BOTTOM (Pivot) ======= -->
<div class="grid" style="margin-top:0;">
  <div class="card" style="grid-column:1 / -1; height:60vh;">
    <div id="pivot-status" style="font-size:12px;color:#667;margin-bottom:6px;">Loading pivot…</div>
    <div id="pivot" style="height:calc(100% - 20px); overflow:auto;"></div>
  </div>
</div>

<script>
  /* ========= Config ========= */
  const CSV_PREVIEW = "data/df3_preview.csv?v=1";            // small/fast table
  const CSV_FULL    = "data/df3_full_for_pivot.csv?v=1";     // full pivot

  /* ========= CSV loader (robust to delimiter; no web worker) ========= */
  function loadCSVAuto(url, done){
    const base = { download:true, header:true, skipEmptyLines:true, worker:false };
    Papa.parse(url, {
      ...base,
      complete: (res) => {
        if (res.data && res.data.length && Object.keys(res.data[0]||{}).length > 1) return done(null, res);
        Papa.parse(url, { ...base, delimiter:";", complete:(r2)=>done(null,r2), error:(e)=>done(e) });
      },
      error: (err) => done(err)
    });
  }

  /* ========= DataTables helpers ========= */
  function colsFromFields(fields){
    return fields.map(name => ({ title: name, data: name }));
  }

  function initDataTable(rows, fields){
    // Destroy prior instance if any
    if ($.fn.dataTable.isDataTable('#dataset')){
      $('#dataset').DataTable().clear().destroy();
      $('#dataset thead').empty();
    }
    // Build <thead>
    const thead = document.querySelector('#dataset thead');
    const tr = document.createElement('tr');
    (fields || Object.keys(rows[0]||{})).forEach(col=>{
      const th = document.createElement('th');
      th.textContent = col;
      tr.appendChild(th);
    });
    thead.appendChild(tr);

    // Init DataTable (Scroller + horiz/vert scroll)
    $('#dataset').DataTable({
      data: rows,
      columns: colsFromFields(fields),
      deferRender: true,
      scroller: true,
      scrollY: '38vh',       // fits inside the top-card
      scrollX: true,
      scrollCollapse: true,
      paging: false,
      searching: true,
      ordering: true,
      info: false,
      autoWidth: false
    });
  }

  /* ========= Load preview table ========= */
  loadCSVAuto(CSV_PREVIEW, (err, res) => {
    const status = document.getElementById('table-status');
    if (err){
      console.error(err);
      if (status) status.textContent = 'Failed to load dataset.';
      document.querySelector('#dataset').outerHTML =
        '<div style="color:#b00; padding:8px;">Failed to load dataset.</div>';
      return;
    }
    const rows = (res.data || []).filter(r => Object.keys(r).length);
    const fields = res.meta?.fields || (rows[0] ? Object.keys(rows[0]) : []);
    if (status) status.textContent = `Loaded ${rows.length.toLocaleString()} rows, ${fields.length} columns`;
    initDataTable(rows, fields);
  });

  // Keep table sized nicely on resize
  window.addEventListener('resize', () => {
    if ($.fn.dataTable.isDataTable('#dataset')){
      $('#dataset').DataTable().columns.adjust().draw(false);
    }
  });

  /* ========= Load Pivot ========= */
  (function(){
    const pstat = document.getElementById('pivot-status');
    loadCSVAuto(CSV_FULL, (err, res) => {
      if (err){
        console.error(err);
        if (pstat) pstat.textContent = 'Failed to load pivot data.';
        return;
      }
      const rows = (res.data || []).filter(r => Object.keys(r).length);
      if (pstat) pstat.textContent = `Pivot loaded: ${rows.length.toLocaleString()} rows`;

      const utils = $.pivotUtilities;
      const renderers = $.extend({}, utils.renderers, utils.plotly_renderers || {});
      $("#pivot").pivotUI(
        rows,
        {
          rendererName: "Table",
          aggregatorName: "Count",
          rows: [],
          cols: [],
          renderers
        },
        true
      );
    });
  })();
</script>
