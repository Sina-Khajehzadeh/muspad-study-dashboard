<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Muspad Study</title>

<!-- Core libs -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- PivotTable.js + deps -->
<script src="https://unpkg.com/jquery@3.7.1/dist/jquery.min.js"></script>
<link  rel="stylesheet" href="https://unpkg.com/jquery-ui-dist@1.13.2/jquery-ui.min.css">
<script src="https://unpkg.com/jquery-ui-dist@1.13.2/jquery-ui.min.js"></script>
<link  rel="stylesheet" href="https://unpkg.com/pivottable@2.23.0/dist/pivot.css">
<script src="https://unpkg.com/pivottable@2.23.0/dist/pivot.min.js"></script>
<script src="https://unpkg.com/pivottable@2.23.0/dist/plotly_renderers.min.js"></script>

<!-- Tabulator (fast interactive grid for big CSVs) -->
<link  rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.6.0/dist/css/tabulator.min.css">
<script src="https://unpkg.com/tabulator-tables@5.6.0/dist/js/tabulator.min.js"></script>

<style>
  :root{
    --page-max: 1900px;
    --gap: 6px;
    --card-bg:#fff;
    --card-br:#e6e9ef;
  }
  *{ box-sizing:border-box }
  body{ font-family:system-ui, Arial, sans-serif; background:#f6f7fb; margin:0 }
  h1{ text-align:center; padding:12px 4px; margin:0; font-weight:700 }

  /* Layout: top row (3 cards) → draggable divider → bottom (pivot) */
  #page{
    max-width:var(--page-max);
    width:min(99vw, var(--page-max));
    margin:6px auto 16px;
    padding:0 4px;
  }

  .grid{
    display:grid;
    grid-template-columns: 1.4fr 1.6fr 1.4fr; /* left | middle | right */
    gap:var(--gap);
    align-items:stretch;
  }
  @media (max-width:1200px){
    .grid{ grid-template-columns:1fr }
  }

  .card{
    background:var(--card-bg);
    border:1px solid var(--card-br);
    border-radius:10px;
    box-shadow:0 1px 3px rgba(0,0,0,.04);
    padding:10px;
    display:flex;
    flex-direction:column;
    min-height:0;
  }
  .card-header{
    margin-bottom:6px;
  }
  .card-title{
    margin:0 0 2px;
    font-size:15px;
    font-weight:650;
  }
  .card-sub{
    margin:0;
    color:#667;
    font-size:12px;
  }

  .chart{ width:100%; height:clamp(320px, 46vh, 640px) }

  /* Interactive grid container (full dataset) */
  #grid-top-wrap{
    display:flex; flex-direction:column; min-height:0;
    height:clamp(240px, 42vh, 440px);
  }
  #grid-top{ flex:1 1 auto; min-height:0 } /* Tabulator mounts here */

  /* Divider (drag to resize the bottom pivot height) */
  #divider{
    height:10px; margin:10px 0; cursor:row-resize;
    background:linear-gradient(#e9eef7,#dfe7f5);
    border:1px solid #d5dcef; border-radius:8px;
  }

  /* Bottom (pivot) */
  #pivot-card{ padding:8px 10px }
  #debug-top, #debug-pivot{ color:#666; font-size:12px; padding:2px 0 6px }
  #pivot{
    height: clamp(420px, 60vh, 800px);  /* draggable will override this inline */
    overflow:auto;
  }

  /* Basic table styles (only used by tiny helper tables, not Tabulator) */
  table{ border-collapse:collapse; width:100%; font-size:12.5px; white-space:nowrap }
  th,td{ border:1px solid #e5e8ef; padding:6px 8px; text-align:left }
  th{ background:#f2f5fb; position:sticky; top:0; z-index:1 }
  .scroll{ max-height:clamp(200px, 40vh, 480px); overflow:auto }
</style>

<h1>Muspad Study — Descriptive Overview</h1>

<div id="page">
  <!-- TOP row -------------------------------------------------------->
  <div class="grid" id="top-row">
    <!-- LEFT: Full dataset grid (Tabulator) -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Dataset (top-left)</h2>
        <p class="card-sub">Full interactive view of <code>df3_full_for_pivot.csv</code>.</p>
        <div id="debug-top"></div>
      </div>
      <div id="grid-top-wrap">
        <div id="grid-top"></div>
      </div>
    </div>

    <!-- MIDDLE: Chart 1 -->
    <div class="card"><div id="chart1" class="chart"></div></div>

    <!-- RIGHT: Chart 2 -->
    <div class="card"><div id="chart2" class="chart"></div></div>
  </div>

  <!-- Divider: drag to resize the bottom area ------------------------>
  <div id="divider" title="Drag to resize the pivot area"></div>

  <!-- BOTTOM: Pivot -------------------------------------------------->
  <div class="card" id="pivot-card">
    <div class="card-header">
      <h2 class="card-title">Pivot / Explore (full dataset)</h2>
      <p class="card-sub">Drag fields into rows/columns. Use “Renderer” to switch (Table, Heatmap, Bar, etc.).</p>
      <div id="debug-pivot"></div>
    </div>
    <div id="pivot"></div>
  </div>
</div>

<script>
  /* ---------- Plotly styling (same as before) ---------- */
  const BASE_WIDTH = 1400;
  const FONT_FAMILY = "Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
  const SIZES = { title: 18, axisTitle: 12, tick: 11, legend: 10.5, hover: 12 };
  const RIGHT_MARGIN = 84;

  const scale = (px, el) => {
    const w = (el?.clientWidth || BASE_WIDTH);
    const s = Math.min(1.15, Math.max(0.9, w / BASE_WIDTH));
    return Math.round(px * s);
  };

  function maybeRotateX(fig){
    try{
      const xs = (fig.data?.[0]?.x || []).map(String);
      if (xs.some(v => v.length > 14)) {
        fig.layout.xaxis = fig.layout.xaxis || {};
        fig.layout.xaxis.tickangle = -30;
      }
    }catch(e){}
  }

  function normalize(fig, el){
    fig.layout = fig.layout || {};
    delete fig.layout.width; delete fig.layout.height;

    fig.layout.template = "plotly_white";
    fig.layout.paper_bgcolor = "#ffffff";
    fig.layout.plot_bgcolor  = "#ffffff";

    const m = fig.layout.margin || {};
    fig.layout.margin = { l: 54, r: Math.max(RIGHT_MARGIN, m.r||0), t: 50, b: 46 };

    fig.layout.font = { family: FONT_FAMILY, size: scale(12.5, el), color:"#213547" };

    fig.layout.title = fig.layout.title || {};
    fig.layout.title.x = (fig.layout.title.x ?? 0.02);
    fig.layout.title.font = { size: scale(SIZES.title, el), family: FONT_FAMILY };

    fig.layout.legend = Object.assign({
      orientation: "v",
      x: 1.003, xanchor: "left",
      y: 1,    yanchor: "top",
      itemsizing: "constant",
      bgcolor: "rgba(255,255,255,0.85)",
      borderwidth: 0,
      font: { size: scale(SIZES.legend, el), family: FONT_FAMILY }
    }, fig.layout.legend || {});

    for (const k of Object.keys(fig.layout)) {
      if (/^[xy]axis(\d+)?$/.test(k)) {
        const ax = fig.layout[k] = Object.assign({
          automargin:true, zeroline:false, showline:true, mirror:true,
          linecolor:"#cfd6e4", linewidth:1,
          gridcolor:"#ecf0f6", ticks:"outside", tickcolor:"#cfd6e4", ticklen:3
        }, fig.layout[k] || {});
        ax.title = ax.title || {};
        ax.title.font = { size: scale(SIZES.axisTitle, el), family: FONT_FAMILY };
        ax.tickfont  = { size: scale(SIZES.tick, el), family: FONT_FAMILY };
        ax.title.standoff = 4;
      }
    }

    if (fig.layout.coloraxis){
      fig.layout.coloraxis.colorbar = Object.assign({
        thickness: 10, outlinewidth: 0,
        tickfont: { size: scale(SIZES.tick, el), family: FONT_FAMILY },
        title:    { font: { size: scale(SIZES.tick, el), family: FONT_FAMILY } }
      }, fig.layout.coloraxis.colorbar || {});
    }

    maybeRotateX(fig);
    return fig;
  }

  function renderChart(id, raw){
    const el = document.getElementById(id);
    const fig = normalize(
      window.structuredClone ? structuredClone(raw) : JSON.parse(JSON.stringify(raw)),
      el
    );
    Plotly.newPlot(id, fig.data, fig.layout, {responsive:true});
    const resize = () => Plotly.Plots.resize(el);
    window.addEventListener("resize", resize);
    if ("ResizeObserver" in window) new ResizeObserver(resize).observe(el);
  }

  /* ---------- Load charts ---------- */
  Promise.all([
    fetch("education.json").then(r => r.json()),
    fetch("employment.json").then(r => r.json())
  ]).then(([fig1, fig2]) => {
    renderChart("chart1", fig1);
    renderChart("chart2", fig2);
  });

  /* ---------- CSV loader with auto delimiter ---------- */
  function loadCSVWithAutoDelimiter(url, done){
    const base = { download:true, header:true, skipEmptyLines:true, dynamicTyping:false, worker:false };
    Papa.parse(url, {
      ...base,
      complete: (res) => {
        if (res.data && res.data.length && Object.keys(res.data[0]||{}).length > 1) return done(null, res);
        Papa.parse(url, { ...base, delimiter:";", complete: (r2)=>done(null,r2), error:(e)=>done(e) });
      },
      error: (err) => done(err)
    });
  }

  /* ---------- Build Tabulator grid (FULL dataset) + Pivot ---------- */
  const topMsg   = (t)=>{ const el=document.getElementById("debug-top");   if(el) el.textContent=t; };
  const pivotMsg = (t)=>{ const el=document.getElementById("debug-pivot"); if(el) el.textContent=t; };

  topMsg("Loading full dataset…");
  pivotMsg("Loading full dataset into pivot…");

  const DATA_URL = "data/df3_full_for_pivot.csv?v=3";

  loadCSVWithAutoDelimiter(DATA_URL, (err, res) => {
    if (err){ topMsg("Load error: "+(err?.message||"unknown")); pivotMsg("Load error."); return; }

    const rows   = (res.data || []).filter(r => Object.keys(r).length);
    const fields = res.meta?.fields || (rows[0] ? Object.keys(rows[0]) : []);

    /* TABULATOR (left panel) */
    const cols = fields.map(f => ({
      title: f, field: f,
      headerFilter: "input",
      headerFilterPlaceholder: "filter…",
      hozAlign: "left"
    }));

    const grid = new Tabulator("#grid-top", {
      data: rows,
      columns: cols,
      height: "100%",
      layout: "fitDataStretch",       /* horizontal scroll when needed */
      movableColumns: true,
      resizableColumns: true,
      columnDefaults:{ resizable:true },
      selectable: false,
      pagination: false,
      reactiveData: false,
      virtualDom: true,               /* fast on big tables */
    });

    topMsg(`Preview loaded: ${rows.length} rows, ${fields.length} columns`);

    /* PIVOT (bottom) */
    const utils = $.pivotUtilities;
    const renderers = $.extend({}, utils.renderers, utils.plotly_renderers || {});
    $("#pivot").pivotUI(
      rows,
      {
        rendererName: "Table",
        aggregatorName: "Count",
        rows: [],
        cols: [],
        renderers: renderers
      },
      true
    );
    pivotMsg(`Pivot loaded: ${rows.length} rows`);
  });

  /* ---------- Draggable divider to resize pivot height ---------- */
  (function(){
    const divider = document.getElementById("divider");
    const pivot   = document.getElementById("pivot");
    let dragging=false, startY=0, startH=0;

    const onDown = (e)=>{
      dragging=true;
      startY = e.clientY || e.touches?.[0]?.clientY || 0;
      startH = pivot.getBoundingClientRect().height;
      document.body.style.userSelect="none";
    };
    const onMove = (e)=>{
      if(!dragging) return;
      const y = e.clientY || e.touches?.[0]?.clientY || 0;
      const dh = y - startY;
      const newH = Math.max(240, startH + dh);
      pivot.style.height = newH + "px";
      // Let PivotTable reflow
      window.dispatchEvent(new Event("resize"));
    };
    const onUp = ()=>{
      dragging=false;
      document.body.style.userSelect="";
    };

    divider.addEventListener("mousedown", onDown);
    divider.addEventListener("touchstart", onDown, {passive:true});
    window.addEventListener("mousemove", onMove);
    window.addEventListener("touchmove", onMove, {passive:false});
    window.addEventListener("mouseup", onUp);
    window.addEventListener("touchend", onUp);
  })();
</script>
